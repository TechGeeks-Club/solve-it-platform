version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: solve-it-db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-solveitdb}
      - POSTGRES_USER=${POSTGRES_USER:-solveit}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-solveit123}
    ports:
      - "5432:5432"
    networks:
      - solve-it-network

  # Redis for Judge0
  redis:
    image: redis:7-alpine
    container_name: solve-it-redis
    volumes:
      - redis_data:/data
    networks:
      - solve-it-network


  # Judge0 Server
  judge0-server:
    image: judge0/judge0:1.13.0
    container_name: solve-it-judge0-server
    volumes:
      - ./judge0/judge0.conf:/judge0.conf:ro
    ports:
      - "2358:2358"
    privileged: true
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - POSTGRES_HOST=judge0-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${JUDGE0_DB:-judge0}
      - POSTGRES_USER=${JUDGE0_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_PASSWORD:-judge0123}
    depends_on:
      - judge0-db
      - redis
    networks:
      - solve-it-network
    restart: unless-stopped

  # Judge0 Workers
  judge0-worker:
    image: judge0/judge0:1.13.0
    container_name: solve-it-judge0-worker
    command: ["./scripts/workers"]
    volumes:
      - ./judge0/judge0.conf:/judge0.conf:ro
    privileged: true
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - POSTGRES_HOST=judge0-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${JUDGE0_DB:-judge0}
      - POSTGRES_USER=${JUDGE0_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_PASSWORD:-judge0123}
    depends_on:
      - judge0-db
      - redis
    networks:
      - solve-it-network
    restart: unless-stopped

  # Judge0 Database
  judge0-db:
    image: postgres:13-alpine
    container_name: solve-it-judge0-db
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${JUDGE0_DB:-judge0}
      - POSTGRES_USER=${JUDGE0_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_PASSWORD:-judge0123}
    networks:
      - solve-it-network


  # Kafka (KRaft mode - no Zookeeper needed)
  kafka:
    image: apache/kafka:latest
    container_name: solve-it-kafka
    restart: unless-stopped
    ports:
      - "9092:9092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 8
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: SolveItKafkaCluster001
    networks:
      - solve-it-network

  # Django Application
  django:
    build:
      context: .
      dockerfile: ./src/Dockerfile
    container_name: solve-it-django
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./src:/app
      - ./database:/app/database
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    environment:
      - DEBUG=${DEBUG:-False}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-change-this-in-production}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1,nginx}
      - POSTGRES_DB=${POSTGRES_DB:-solveitdb}
      - POSTGRES_USER=${POSTGRES_USER:-solveit}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-solveit123}
      - DB_HOST=db
      - DB_PORT=5432
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - db
      - kafka
      - redis
    networks:
      - solve-it-network
    restart: unless-stopped

  # Django Kafka Consumer (for receiving results)
  django-consumer:
    build:
      context: .
      dockerfile: ./src/Dockerfile
    container_name: solve-it-django-consumer
    command: python manage.py consume_results
    volumes:
      - ./src:/app
      - ./database:/app/database
    environment:
      - DEBUG=${DEBUG:-False}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-change-this-in-production}
      - POSTGRES_DB=${POSTGRES_DB:-solveitdb}
      - POSTGRES_USER=${POSTGRES_USER:-solveit}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-solveit123}
      - DB_HOST=db
      - DB_PORT=5432
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - db
      - django
      - kafka
    networks:
      - solve-it-network
    restart: unless-stopped

  # Judge Microservice
  judge-microservice:
    build:
      context: ./judge-microservice
      dockerfile: Dockerfile
    container_name: solve-it-judge-microservice
    volumes:
      - ./judge-microservice:/app
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - JUDGE0_API_URL=http://judge0-server:2358
      - JUDGE0_TIMEOUT=${JUDGE0_TIMEOUT:-30}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_CACHE_TTL=${REDIS_CACHE_TTL:-3600}
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-solveitdb}
      - DB_USER=${POSTGRES_USER:-solveit}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-solveit123}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - kafka
      - judge0-server
      - redis
      - db
    networks:
      - solve-it-network
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: solve-it-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - static_volume:/static:ro
      - media_volume:/media:ro
    depends_on:
      - django
    networks:
      - solve-it-network
    restart: unless-stopped

volumes:
  postgres_data:
  judge0_postgres_data:
  redis_data:
  kafka_data:
  static_volume:
  media_volume:

networks:
  solve-it-network:
    driver: bridge
