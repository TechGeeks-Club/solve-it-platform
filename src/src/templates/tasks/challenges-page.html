{% extends "components/base.html" %}
{% load static %}

{% block title %}Challenges | Solve It{% endblock %}

{% block extra_css %}
{% include "components/common-styles.html" %}
<link rel="stylesheet" href="{% static 'css/challenges-page.css' %}">
{% endblock %}

{% block content %}
{% include "components/navbar.html" %}

<main class="container">
  <div class="page-header">
    <h1>Challenges</h1>
    <p>Solve programming challenges and earn points</p>
  </div>

  <div class="filters-row" style="display: flex; gap: 16px; margin-bottom: 18px;">
    <div class="level-filter">
      <select id="levelsDropdown" class="level-select">
        <option value="all">All Levels</option>
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
    </div>
    <div class="status-filter">
      <select id="statusDropdown" class="level-select">
        <option value="all">All Statuses</option>
        <option value="solved">Solved</option>
        <option value="unsolved">Unsolved</option>
        <option value="completed">Completed</option>
        <option value="failed">Failed</option>
      </select>
    </div>
  </div>

  <div class="challenge-list">
    {% if tasks_with_status %} 
      {% for item in tasks_with_status %}
        {% with task=item.task solution=item.solution %}
    <div
      class="challenge-card"
      data-phase="{{ task.phase.name }}"
      data-level="{{ task.level|lower }}"
      data-status="{{ item.status_val }}"
    >
      <div class="challenge-info">
        <div class="challenge-details">
          <h3>{{ task.title }}</h3>
          <div class="challenge-meta">
            {% if task.level %}
              <span class="level-tag {{ task.level|lower }}">{{ task.level|capfirst }}</span>
            {% endif %}
            <span>{{ task.points }} points</span>
            {% if task.category %}
              <span>{{ task.category }}</span>
            {% endif %}
            
            {% if solution %}
              <span>Attempts: {{ item.attempts }}/{{ item.max_attempts }}</span>
              <span>Score: {{ item.score }}%</span>
            {% endif %}
          </div>
        </div>
      </div>

      {% if solution %}
        {% if not item.is_corrected %}
          <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #ffa50080; color: #fff; cursor: pointer;">In Progress ({{ item.attempts }}/{{ item.max_attempts }})</button>
        {% elif item.can_access %}
          {% if item.score >= pass_threshold %}
            <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #46e34c; color: #fff; cursor: pointer;">Success ({{ item.attempts }}/{{ item.max_attempts }})</button>
          {% else %}
            <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #ff4444; color: #fff; cursor: pointer;">Failed ({{ item.attempts }}/{{ item.max_attempts }})</button>
          {% endif %}
        {% else %}
          {% if item.status_text == "Success" %}
            <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #46e34c; color: #fff; cursor: pointer;">Success ✓</button>
          {% else %}
            <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #ff4444; color: #fff; cursor: pointer;">Failed ✗</button>
          {% endif %}
        {% endif %}
      {% else %}
        <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn">Solve</button>
      {% endif %}
    </div>
        {% endwith %}
      {% endfor %}
    {% endif %}
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/challenges-page.js' %}"></script>
{% endblock %}
