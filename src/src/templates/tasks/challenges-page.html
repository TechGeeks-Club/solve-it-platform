{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Challenges | Solve It</title>
    <link rel="stylesheet" href="{% static 'css/challenge-page.css' %}" />
    {% include "components/com_header.html"%}

  </head>
  <body>
    <section class="all-Page">
      {% include "components/nav.html" %}

      <main class="container">
        <div class="page-header">
          <h1>Challenges</h1>
        </div>

        {% comment %} <div class="tabs">
          <div class="level-filter">
            <select id="phasesDropdown" class="level-select">
              <option value="all">All Phases</option>
              {% for phase in phases.all %} 
                {% if not phase.is_locked %}
                  {% if phase.name == "phase 3" %}
                    <option value="{% url 'thirdPhase' %}">{{ phase.name }}</option>
                  {% else %}
                    <option value="{{ phase.name }}">{{ phase.name }}</option>
                  {% endif %}
                {% endif %} 
              {% endfor %}
            </select>
          </div> {% endcomment %}

          <div class="level-filter">
            <select id="levelsDropdown" class="level-select">
              <option value="all">All Levels</option>
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
        </div>

        <div class="challenge-list">
          {% if tasks_with_status %} 
            {% for item in tasks_with_status %}
              {% with task=item.task solution=item.solution %}
          <div
            class="challenge-card"
            data-phase="{{ phase.name }}"
            data-level="{{ task.level|lower }}"
          >
            <div class="challenge-info">
              <div class="challenge-checkbox"><input type="checkbox" /></div>
              <div class="challenge-details">
                <h3>{{ task.title }}</h3>
                <div class="challenge-meta">
                  {% if task.level %}
                    <span class="level-tag {{ task.level|lower }}">Level: {{ task.level|capfirst }}</span>
                  {% endif %}

                  <span>Score: {{ task.points }} points</span>
                  {% if task.category %}
                    <span>Category: {{ task.category }}</span>
                  {% endif %}
                  
                  {% if solution %}
                    <span>Attempts: {{ item.attempts }}/{{ item.max_attempts }}</span>
                    <span>Your Score: {{ item.score }}%</span>
                  {% endif %}
                </div>
              </div>
            </div>

            {% if solution %}
              {% if not item.is_corrected %}
                <!-- Still processing or not corrected yet -->
                <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #ffa50080; color: #fff; cursor: pointer;">In Progress ({{ item.attempts }}/{{ item.max_attempts }})</button>
              {% elif item.can_access %}
                <!-- Corrected but can still submit (attempts < max) -->
                {% if item.score >= pass_threshold %}
                  <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #46e34c; color: #fff; cursor: pointer;">Success ({{ item.attempts }}/{{ item.max_attempts }})</button>
                {% else %}
                  <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #ff4444; color: #fff; cursor: pointer;">Failed ({{ item.attempts }}/{{ item.max_attempts }})</button>
                {% endif %}
              {% else %}
                <!-- Max attempts reached - show pass/fail status -->
                {% if item.status_text == "Success" %}
                  <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #46e34c; color: #fff; cursor: pointer;">Success ✓</button>
                {% else %}
                  <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn" style="background-color: #ff4444; color: #fff; cursor: pointer;">Failed ✗</button>
                {% endif %}
              {% endif %}
            {% else %}
              <button onclick="window.location.href=`{% url 'task' task.id %}`" class="solve-btn">Solve</button>
            {% endif %}
          </div>
              {% endwith %}
            {% endfor %}
          {% endif %}
        </div>
      </main>
    </section>

    <script>
      const levelsDropdown = document.getElementById("levelsDropdown");
    
      function filterChallenges() {
        const selectedLevel = levelsDropdown.value.toLowerCase();
        const challengeCards = document.querySelectorAll(".challenge-card");
    
        challengeCards.forEach((card) => {
          const cardLevel = card.getAttribute("data-level");
          const matchesLevel = selectedLevel === "all" || cardLevel === selectedLevel;
    
          if (matchesLevel) {
            card.style.display = "flex";
          } else {
            card.style.display = "none";
          }
        });
      }
    
      levelsDropdown.addEventListener("change", filterChallenges);
    
      function toggleMenu() {
        const menu = document.getElementById("dropdownMenu");
        menu.style.display = menu.style.display === "flex" ? "none" : "flex";
      }
    
      function closeDropDown() {
        const menu = document.getElementById("dropdownMenu");
        if (menu.style.display === "flex") menu.style.display = "none";
      }
    </script>
  </body>
</html>
