{% extends "components/base.html" %}
{% load static %}

{% block title %}{{task.title}} - Challenge{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

{% include "components/common-styles.html" %}

<style>
  /* Challenge Page Specific Styles */
  .challenge-container {
    display: flex;
    height: 100vh;
    padding-top: 50px;
    overflow: hidden;
  }

  /* Problem Panel */
  .problem-panel {
    width: 50%;
    background: #252526;
    overflow-y: auto;
    border-right: 1px solid #3e3e42;
    height: calc(100vh - 50px);
  }

  .problem-header {
    padding: 24px 32px;
    border-bottom: 1px solid #3e3e42;
    background: #2d2d30;
  }

  .problem-title {
    font-size: 24px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 12px;
  }

  .problem-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }

  .problem-content {
    padding: 32px;
  }

  .example-box {
    background: #1e1e1e;
    border: 1px solid #3e3e42;
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 12px;
  }

  .example-label {
    color: #858585;
    font-size: 12px;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .example-value {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    color: #4ec9b0;
    font-size: 14px;
  }

  /* Editor Panel */
  .editor-panel {
    width: 50%;
    display: flex;
    flex-direction: column;
    background: #1e1e1e;
    overflow: hidden;
    height: calc(100vh - 50px);
  }

  .editor-header {
    padding: 16px 24px;
    background: #2d2d30;
    border-bottom: 1px solid #3e3e42;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .editor-tabs {
    display: flex;
    gap: 8px;
  }

  .editor-tab {
    padding: 8px 16px;
    background: #1e1e1e;
    border: 1px solid #3e3e42;
    border-radius: 4px 4px 0 0;
    color: #cccccc;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .editor-tab.active {
    background: #1e1e1e;
    color: #fff;
    border-bottom: 2px solid #0e639c;
  }

  .editor-actions {
    display: flex;
    gap: 8px;
  }

  .editor-body {
    flex: 1;
    position: relative;
    overflow: hidden;
    min-height: 0;
  }

  .CodeMirror {
    height: 100% !important;
    font-size: 14px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  }

  .editor-footer {
    padding: 12px 24px;
    background: #2d2d30;
    border-top: 1px solid #3e3e42;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .status-info {
    display: flex;
    gap: 16px;
    font-size: 13px;
    color: #858585;
  }

  .status-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* Test Results Section */
  .test-results-section {
    background: #1e1e1e;
    border-top: 1px solid #3e3e42;
    max-height: 200px;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .test-results-header {
    padding: 12px 24px;
    background: #252526;
    border-bottom: 1px solid #3e3e42;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .test-results-title {
    font-size: 13px;
    font-weight: 600;
    color: #cccccc;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .test-results-summary {
    font-size: 12px;
    color: #858585;
  }

  .test-results-list {
    padding: 8px;
  }

  .test-case-item {
    margin-bottom: 4px;
    background: #252526;
    border-left: 3px solid;
    border-radius: 4px;
    overflow: hidden;
  }

  .test-case-header {
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
  }

  .test-case-header:hover {
    background: #2d2d30;
  }

  .test-case-header.locked {
    cursor: default;
  }

  .test-case-item.passed {
    border-left-color: #3fb950;
  }

  .test-case-item.failed {
    border-left-color: #f85149;
  }

  .test-case-name {
    font-size: 13px;
    color: #d4d4d4;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .test-case-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .test-case-status {
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .test-case-status.passed {
    color: #3fb950;
  }

  .test-case-status.failed {
    color: #f85149;
  }

  .test-status-icon {
    font-size: 16px;
  }

  .accordion-icon {
    color: #858585;
    transition: transform 0.3s;
    display: flex;
    align-items: center;
  }

  .accordion-icon svg {
    width: 14px;
    height: 14px;
  }

  .accordion-icon.expanded {
    transform: rotate(90deg);
  }

  .lock-icon {
    color: #858585;
    display: flex;
    align-items: center;
  }

  .lock-icon svg {
    width: 14px;
    height: 14px;
  }

  .test-case-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    background: #1e1e1e;
  }

  .test-case-details.expanded {
    max-height: 300px;
    overflow-y: auto;
  }

  .test-case-content {
    padding: 12px 16px;
    border-top: 1px solid #3e3e42;
  }

  .test-io-section {
    margin-bottom: 12px;
  }

  .test-io-section:last-child {
    margin-bottom: 0;
  }

  .test-io-label {
    font-size: 11px;
    text-transform: uppercase;
    color: #858585;
    font-weight: 600;
    margin-bottom: 6px;
    letter-spacing: 0.5px;
  }

  .test-io-value {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 12px;
    color: #4ec9b0;
    background: #252526;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #3e3e42;
    white-space: pre-wrap;
    word-break: break-all;
  }

  /* Loading Spinner */
  .spinner {
    border: 2px solid #3e3e42;
    border-top: 2px solid #58a6ff;
    border-radius: 50%;
    width: 14px;
    height: 14px;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .challenge-container {
      flex-direction: column;
    }
    .problem-panel, .editor-panel {
      width: 100%;
      height: 50vh;
    }
  }
</style>
{% endblock %}

{% block content %}
{% include "components/navbar.html" %}

<div class="challenge-container">
  <!-- Left Panel: Problem Description -->
  <div class="problem-panel">
    <div class="problem-header">
      <h1 class="problem-title">{{task.title}}</h1>
      <div class="problem-meta">
        {% if task.level %}
          <span class="meta-tag level-{{ task.level|lower }}">{{ task.level|capfirst }}</span>
        {% endif %}
        <span class="meta-tag meta-points">{{ task.points }} points</span>
        <span class="meta-tag meta-attempts">{{ current_attempts }}/{{ max_attempts }} attempts</span>
        {% if tasksolution %}
          <span class="meta-tag meta-score">Score: {{ tasksolution.score }}%</span>
        {% endif %}
      </div>
    </div>

    <div class="problem-content">
      <div class="section">
        <h2 class="section-title">Problem Statement</h2>
        <div class="section-text">{{ task.context|linebreaksbr }}</div>
      </div>

      {% if task.task_tests.all %}
      <div class="section">
        <h2 class="section-title">Sample Test Cases</h2>
        {% for test in task.task_tests.all %}
          {% if test.is_sample or test.display %}
          <div class="example-box">
            <div class="example-label">Sample Input {{ forloop.counter }}</div>
            <div class="example-value">{{ test.input|default:"(empty)" }}</div>
          </div>
          <div class="example-box">
            <div class="example-label">Sample Output {{ forloop.counter }}</div>
            <div class="example-value">{{ test.output }}</div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Right Panel: Code Editor -->
  <div class="editor-panel">
    <div class="editor-header">
      <div class="editor-tabs">
        <div class="editor-tab active">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4.708 5.578L2.061 8.224l2.647 2.646-.708.708-3-3V7.87l3-3 .708.708zm7-.708L11 5.578l2.647 2.646L11 10.87l.708.708 3-3V7.87l-3-3zM4.908 13l.894.448 5-10L9.908 3l-5 10z"/>
          </svg>
          solution.c
        </div>
      </div>
      <div class="editor-actions">
        <button id="resetBtn" class="btn" {% if not can_submit %}disabled{% endif %} title="Reset to initial code">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
            <path d="M21 3v5h-5"/>
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
            <path d="M3 21v-5h5"/>
          </svg>
          Reset
        </button>
      </div>
    </div>

    <div class="editor-body">
      <textarea id="codeEditor">{% if tasksolution %}{{ tasksolution.code }}{% else %}{{ task.initialCode }}{% endif %}</textarea>
    </div>

    <div class="editor-footer">
      <div class="status-info">
        <div class="status-item">
          <span class="status-icon {% if can_submit %}ready{% elif tasksolution.status == 'processing' %}processing{% elif tasksolution.status == 'completed' %}ready{% else %}blocked{% endif %}"></span>
          <span>
            {% if can_submit and not tasksolution %}
              Ready to submit
            {% elif tasksolution.status == 'processing' %}
              Processing...
            {% elif tasksolution.status == 'completed' %}
              Passed ({{ tasksolution.score }}%)
            {% elif tasksolution.status == 'failed' %}
              Failed ({{ tasksolution.score }}%)
            {% elif not can_submit %}
              Max attempts reached
            {% else %}
              Ready to submit
            {% endif %}
          </span>
        </div>
        {% if tasksolution and tasksolution.is_corrected %}
        <div class="status-item">
          <span>Result: 
            <span style="color: {% if tasksolution.status == 'completed' %}#3fb950{% elif tasksolution.status == 'failed' %}#f85149{% else %}#f0b341{% endif %}; font-weight: 600;">
              {{ tasksolution.status|capfirst }}
            </span>
          </span>
        </div>
        {% endif %}
      </div>
      <button id="submitBtn" 
              class="btn {% if tasksolution.status == 'processing' %}btn-warning{% elif can_submit %}btn-success{% else %}btn-danger{% endif %}"
              {% if not can_submit or tasksolution.status == 'processing' %}disabled{% endif %}>
        {% if tasksolution.status == 'processing' %}
          <div class="spinner"></div>
          Processing...
        {% else %}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          {% if can_submit %}
            Submit Code ({{ remaining_attempts }} left)
          {% else %}
            Max Attempts Reached
          {% endif %}
        {% endif %}
      </button>
      
      <!-- Time Machine Button -->
      {% if has_time_machine and not can_submit %}
      <form method="POST" action="{% url 'use_time_machine' task.id %}" style="display: inline-block; margin-left: 12px;">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; display: flex; align-items: center; gap: 8px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Use Time Machine
        </button>
      </form>
      {% elif time_machine_used %}
      <button class="btn btn-secondary" disabled style="margin-left: 12px; opacity: 0.5; display: flex; align-items: center; gap: 8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Time Machine Used
      </button>
      {% endif %}
    </div>

    <!-- Test Results Section -->
    {% if tasksolution and tasksolution.test_results %}
    <div class="test-results-section">
      <div class="test-results-header">
        <div class="test-results-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          Test Cases
        </div>
        <div class="test-results-summary">
          {{ tasksolution.passed_tests }}/{{ tasksolution.total_tests }} passed
        </div>
      </div>
      <div class="test-results-list">
        {% for test in tasksolution.test_results %}
        <div class="test-case-item {% if test.passed %}passed{% else %}failed{% endif %}">
          <div class="test-case-header {% if not test.display %}locked{% endif %}" onclick="{% if test.display %}toggleTestCase({{ forloop.counter0 }}){% endif %}">
            <div class="test-case-name">
              <span class="test-status-icon">
                {% if test.passed %}✓{% else %}✗{% endif %}
              </span>
              Test Case {{ forloop.counter }}
            </div>
            <div class="test-case-right">
              <div class="test-case-status {% if test.passed %}passed{% else %}failed{% endif %}">
                {% if test.passed %}
                  Passed
                {% else %}
                  Failed
                {% endif %}
              </div>
              {% if test.display %}
                <span class="accordion-icon" id="accordion-icon-{{ forloop.counter0 }}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </span>
              {% else %}
                <span class="lock-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                </span>
              {% endif %}
            </div>
          </div>
          {% if test.display %}
          <div class="test-case-details" id="test-details-{{ forloop.counter0 }}">
            <div class="test-case-content">
              <div class="test-io-section">
                <div class="test-io-label">Input</div>
                <div class="test-io-value">{{ test.input|default:"(empty)" }}</div>
              </div>
              <div class="test-io-section">
                <div class="test-io-label">Expected Output</div>
                <div class="test-io-value">{{ test.expected_output|default:"N/A" }}</div>
              </div>
              {% if not test.passed and test.actual_output %}
              <div class="test-io-section">
                <div class="test-io-label">Your Output</div>
                <div class="test-io-value">{{ test.actual_output }}</div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Hidden Form -->
<div style="display: none">
  <form action="{{task.id}}" method="POST" id="hiddenForm" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="uploadedFile" id="uploadedFile" required />
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>

<script>
  // Initialize CodeMirror
  let editor;
  const initialCode = `{{task.initialCode|escapejs}}`;
  const canSubmit = {{ can_submit|yesno:"true,false" }};
  
  document.addEventListener("DOMContentLoaded", function () {
    editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
      lineNumbers: true,
      mode: "text/x-csrc",
      theme: "monokai",
      indentUnit: 4,
      tabSize: 4,
      matchBrackets: true,
      autoCloseBrackets: true,
      readOnly: !canSubmit,
      lineWrapping: false,
      extraKeys: {
        "Tab": function(cm) {
          if (cm.somethingSelected()) {
            cm.indentSelection("add");
          } else {
            cm.replaceSelection("    ", "end");
          }
        }
      }
    });

    editor.setSize(null, "100%");
  });

  // Reset button
  document.getElementById("resetBtn")?.addEventListener("click", function () {
    if (!this.disabled && editor) {
      editor.setValue(initialCode);
    }
  });

  // Submit button
  document.getElementById("submitBtn")?.addEventListener("click", function () {
    if (this.disabled) return;
    
    const code = editor ? editor.getValue() : document.getElementById("codeEditor").value;

    if (!code.trim()) {
      alert("Please write some code before submitting!");
      return;
    }

    // Check if there's a previous submission
    const hasPreviousSubmission = {{ tasksolution|yesno:"true,false" }};
    const currentAttempts = {{ current_attempts|default:0 }};
    
    if (hasPreviousSubmission && currentAttempts > 0) {
      const confirmed = confirm(
        "⚠️ Warning: This submission will overwrite your previous attempt.\n\n" +
        "Your current score: {{ tasksolution.score|default:0 }}%\n" +
        "Attempts used: " + currentAttempts + "/{{ max_attempts }}\n\n" +
        "Are you sure you want to continue?"
      );
      
      if (!confirmed) {
        return; // User cancelled, don't submit
      }
    }

    // Disable button immediately and show loading state
    this.disabled = true;
    this.innerHTML = '<div class="spinner"></div> Submitting...';
    this.className = 'btn btn-warning';

    const file = new Blob([code], { type: "text/plain" });
    const inputElement = document.getElementById("uploadedFile");
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(new File([file], "code.c"));
    inputElement.files = dataTransfer.files;

    document.getElementById("hiddenForm").submit();
  });

  // Toggle test case accordion
  function toggleTestCase(index) {
    const details = document.getElementById(`test-details-${index}`);
    const icon = document.getElementById(`accordion-icon-${index}`);
    
    if (details && icon) {
      if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        icon.classList.remove('expanded');
      } else {
        details.classList.add('expanded');
        icon.classList.add('expanded');
      }
    }
  }
</script>
{% endblock %}
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #1e1e1e;
        color: #d4d4d4;
        overflow: hidden;
      }

      /* Top Navigation */
      .top-nav {
        height: 50px;
        background: #2d2d30;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #fff;
        text-decoration: none;
        font-weight: 600;
        font-size: 16px;
      }

      .nav-logo img {
        height: 30px;
      }

      .nav-center {
        color: #858585;
        font-size: 14px;
      }

      .nav-right {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .nav-link {
        color: #cccccc;
        text-decoration: none;
        font-size: 14px;
        padding: 6px 12px;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .nav-link:hover {
        background: #3e3e42;
        color: #fff;
      }

      .nav-link.logout {
        background: #da3633;
        color: #fff;
      }

      .nav-link.logout:hover {
        background: #f85149;
      }

      /* Main Container */
      .challenge-container {
        display: flex;
        height: calc(100vh - 50px);
        margin-top: 50px;
      }

      /* Left Panel - Problem Description */
      .problem-panel {
        width: 50%;
        background: #252526;
        overflow-y: auto;
        border-right: 1px solid #3e3e42;
      }

      .problem-header {
        padding: 24px 32px;
        border-bottom: 1px solid #3e3e42;
        background: #2d2d30;
      }

      .problem-title {
        font-size: 24px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 12px;
      }

      .problem-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .meta-tag {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
      }

      .level-easy { background: #2ea04326; color: #3fb950; border: 1px solid #3fb950; }
      .level-medium { background: #d2910033; color: #f0b341; border: 1px solid #f0b341; }
      .level-hard { background: #da363733; color: #f85149; border: 1px solid #f85149; }

      .meta-points {
        background: #1f6feb26;
        color: #58a6ff;
        border: 1px solid #58a6ff;
      }

      .meta-attempts {
        background: #8957e526;
        color: #bc8cff;
        border: 1px solid #bc8cff;
      }

      .meta-score {
        background: #3fb95026;
        color: #56d364;
        border: 1px solid #56d364;
      }

      .problem-content {
        padding: 32px;
      }

      .section {
        margin-bottom: 32px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3e3e42;
      }

      .section-text {
        line-height: 1.8;
        color: #cccccc;
        white-space: pre-wrap;
      }

      .example-box {
        background: #1e1e1e;
        border: 1px solid #3e3e42;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .example-label {
        color: #858585;
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .example-value {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        color: #4ec9b0;
        font-size: 14px;
      }

      /* Right Panel - Code Editor */
      .editor-panel {
        width: 50%;
        display: flex;
        flex-direction: column;
        background: #1e1e1e;
      }

      .editor-header {
        padding: 16px 24px;
        background: #2d2d30;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .editor-tabs {
        display: flex;
        gap: 8px;
      }

      .editor-tab {
        padding: 8px 16px;
        background: #1e1e1e;
        border: 1px solid #3e3e42;
        border-radius: 4px 4px 0 0;
        color: #cccccc;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .editor-tab.active {
        background: #1e1e1e;
        color: #fff;
        border-bottom: 2px solid #0e639c;
      }

      .editor-actions {
        display: flex;
        gap: 8px;
      }

      .btn {
        padding: 8px 16px;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        background: #2d2d30;
        color: #cccccc;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .btn:hover:not(:disabled) {
        background: #3e3e42;
        color: #fff;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #0e639c;
        color: #fff;
        border-color: #1177bb;
      }

      .btn-primary:hover:not(:disabled) {
        background: #1177bb;
      }

      .btn-success {
        background: #238636;
        color: #fff;
        border-color: #2ea043;
      }

      .btn-success:hover:not(:disabled) {
        background: #2ea043;
      }

      .btn-danger {
        background: #da3633;
        color: #fff;
        border-color: #f85149;
      }

      .editor-body {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      .CodeMirror {
        height: 100% !important;
        font-size: 14px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      }

      .editor-footer {
        padding: 12px 24px;
        background: #2d2d30;
        border-top: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-info {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: #858585;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-icon {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .status-icon.ready { background: #3fb950; }
      .status-icon.processing { background: #f0b341; }
      .status-icon.blocked { background: #f85149; }

      /* Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      ::-webkit-scrollbar-track {
        background: #1e1e1e;
      }

      ::-webkit-scrollbar-thumb {
        background: #424242;
        border-radius: 6px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #4e4e4e;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .challenge-container {
          flex-direction: column;
        }
        .problem-panel, .editor-panel {
          width: 100%;
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation -->
    <nav class="top-nav">
      <a class="nav-logo" href="{% url 'home' %}">
        <img src="{% static 'img/favicon.webp' %}" alt="Logo">
        <span>Solve It</span>
      </a>
      <div class="nav-center">
        {% if request.user.is_authenticated %}
          <span>{{ request.user.participant.team.name }} | {{ request.user.username }}</span>
        {% endif %}
      </div>
      <div class="nav-right">
        <a href="{% url 'home' %}" class="nav-link">Home</a>
        {% if request.user.is_authenticated %}
          <a href="{% url 'tasksDisplay' %}" class="nav-link">Challenges</a>
          <a href="{% url 'logout' %}" class="nav-link logout">Logout</a>
        {% else %}
          <a href="{% url 'login' %}" class="nav-link">Sign in</a>
        {% endif %}
      </div>
    </nav>

    <div class="challenge-container">
      <!-- Left Panel: Problem Description -->
      <div class="problem-panel">
        <div class="problem-header">
          <h1 class="problem-title">{{task.title}}</h1>
          <div class="problem-meta">
            {% if task.level %}
              <span class="meta-tag level-{{ task.level|lower }}">{{ task.level|capfirst }}</span>
            {% endif %}
            <span class="meta-tag meta-points">{{ task.points }} points</span>
            <span class="meta-tag meta-attempts">{{ current_attempts }}/{{ max_attempts }} attempts</span>
            {% if tasksolution %}
              <span class="meta-tag meta-score">Score: {{ tasksolution.score }}%</span>
            {% endif %}
          </div>
        </div>

        <div class="problem-content">
          <div class="section">
            <h2 class="section-title">Problem Statement</h2>
            <div class="section-text">{{ task.context|linebreaksbr }}</div>
          </div>

          {% if task.task_tests.all %}
          <div class="section">
            <h2 class="section-title">Sample Test Cases</h2>
            {% for test in task.task_tests.all %}
              {% if test.is_sample or test.display %}
              <div class="example-box">
                <div class="example-label">Sample Input {{ forloop.counter }}</div>
                <div class="example-value">{{ test.input|default:"(empty)" }}</div>
              </div>
              <div class="example-box">
                <div class="example-label">Sample Output {{ forloop.counter }}</div>
                <div class="example-value">{{ test.output }}</div>
              </div>
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Right Panel: Code Editor -->
      <div class="editor-panel">
        <div class="editor-header">
          <div class="editor-tabs">
            <div class="editor-tab active">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4.708 5.578L2.061 8.224l2.647 2.646-.708.708-3-3V7.87l3-3 .708.708zm7-.708L11 5.578l2.647 2.646L11 10.87l.708.708 3-3V7.87l-3-3zM4.908 13l.894.448 5-10L9.908 3l-5 10z"/>
              </svg>
              solution.c
            </div>
          </div>
          <div class="editor-actions">
            <button id="resetBtn" class="btn" {% if not can_submit %}disabled{% endif %} title="Reset to initial code">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path d="M3 21v-5h5"/>
              </svg>
              Reset
            </button>
          </div>
        </div>

        <div class="editor-body">
          <textarea id="codeEditor">{% if tasksolution %}{{ tasksolution.code }}{% else %}{{ task.initialCode }}{% endif %}</textarea>
        </div>

        <div class="editor-footer">
          <div class="status-info">
            <div class="status-item">
              <span class="status-icon {% if can_submit %}ready{% elif tasksolution.status == 'processing' %}processing{% else %}blocked{% endif %}"></span>
              <span>
                {% if can_submit %}
                  Ready to submit
                {% elif tasksolution.status == 'processing' %}
                  Processing...
                {% else %}
                  Max attempts reached
                {% endif %}
              </span>
            </div>
            {% if tasksolution %}
            <div class="status-item">
              <span>Status: {{ tasksolution.status|capfirst }}</span>
            </div>
            {% endif %}
          </div>
          <button id="submitBtn" 
                  class="btn {% if can_submit %}btn-success{% else %}btn-danger{% endif %}"
                  {% if not can_submit %}disabled{% endif %}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            {% if can_submit %}
              Submit Code ({{ remaining_attempts }} left)
            {% else %}
              Max Attempts Reached
            {% endif %}
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden Form -->
    <div style="display: none">
      <form action="{{task.id}}" method="POST" id="hiddenForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="uploadedFile" id="uploadedFile" required />
      </form>
    </div>

    <script>
      // Initialize CodeMirror
      let editor;
      const initialCode = `{{task.initialCode|escapejs}}`;
      const canSubmit = {{ can_submit|yesno:"true,false" }};
      
      document.addEventListener("DOMContentLoaded", function () {
        editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
          lineNumbers: true,
          mode: "text/x-csrc",
          theme: "monokai",
          indentUnit: 4,
          tabSize: 4,
          matchBrackets: true,
          autoCloseBrackets: true,
          readOnly: !canSubmit,
          lineWrapping: false,
          extraKeys: {
            "Tab": function(cm) {
              if (cm.somethingSelected()) {
                cm.indentSelection("add");
              } else {
                cm.replaceSelection("    ", "end");
              }
            }
          }
        });

        // Set editor height
        editor.setSize(null, "100%");
      });

      // Reset button
      document.getElementById("resetBtn")?.addEventListener("click", function () {
        if (!this.disabled && editor) {
          editor.setValue(initialCode);
        }
      });

      // Submit button
      document.getElementById("submitBtn")?.addEventListener("click", function () {
        if (this.disabled) return;
        
        const code = editor ? editor.getValue() : document.getElementById("codeEditor").value;

        if (!code.trim()) {
          alert("Please write some code before submitting!");
          return;
        }

        // Create file and submit
        const file = new Blob([code], { type: "text/plain" });
        const inputElement = document.getElementById("uploadedFile");
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([file], "code.c"));
        inputElement.files = dataTransfer.files;

        // Submit form
        document.getElementById("hiddenForm").submit();
      });
    </script>
  </body>
</html>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #1e1e1e;
        color: #d4d4d4;
        overflow: hidden;
      }

      .challenge-container {
        display: flex;
        height: calc(100vh - 60px);
        margin-top: 60px;
      }

      /* Left Panel - Problem Description */
      .problem-panel {
        width: 50%;
        background: #252526;
        overflow-y: auto;
        border-right: 1px solid #3e3e42;
      }

      .problem-header {
        padding: 24px 32px;
        border-bottom: 1px solid #3e3e42;
        background: #2d2d30;
      }

      .problem-title {
        font-size: 24px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 12px;
      }

      .problem-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .meta-tag {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
      }

      .level-easy { background: #2ea04326; color: #3fb950; border: 1px solid #3fb950; }
      .level-medium { background: #d2910033; color: #f0b341; border: 1px solid #f0b341; }
      .level-hard { background: #da363733; color: #f85149; border: 1px solid #f85149; }

      .meta-points {
        background: #1f6feb26;
        color: #58a6ff;
        border: 1px solid #58a6ff;
      }

      .meta-attempts {
        background: #8957e526;
        color: #bc8cff;
        border: 1px solid #bc8cff;
      }

      .meta-score {
        background: #3fb95026;
        color: #56d364;
        border: 1px solid #56d364;
      }

      .problem-content {
        padding: 32px;
      }

      .section {
        margin-bottom: 32px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3e3e42;
      }

      .section-text {
        line-height: 1.8;
        color: #cccccc;
        white-space: pre-wrap;
      }

      .example-box {
        background: #1e1e1e;
        border: 1px solid #3e3e42;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .example-label {
        color: #858585;
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .example-value {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        color: #4ec9b0;
        font-size: 14px;
      }

      /* Right Panel - Code Editor */
      .editor-panel {
        width: 50%;
        display: flex;
        flex-direction: column;
        background: #1e1e1e;
      }

      .editor-header {
        padding: 16px 24px;
        background: #2d2d30;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .editor-tabs {
        display: flex;
        gap: 8px;
      }

      .editor-tab {
        padding: 8px 16px;
        background: #1e1e1e;
        border: 1px solid #3e3e42;
        border-radius: 4px 4px 0 0;
        color: #cccccc;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .editor-tab.active {
        background: #1e1e1e;
        color: #fff;
        border-bottom: 2px solid #0e639c;
      }

      .editor-actions {
        display: flex;
        gap: 8px;
      }

      .btn {
        padding: 8px 16px;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        background: #2d2d30;
        color: #cccccc;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .btn:hover:not(:disabled) {
        background: #3e3e42;
        color: #fff;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #0e639c;
        color: #fff;
        border-color: #1177bb;
      }

      .btn-primary:hover:not(:disabled) {
        background: #1177bb;
      }

      .btn-success {
        background: #238636;
        color: #fff;
        border-color: #2ea043;
      }

      .btn-success:hover:not(:disabled) {
        background: #2ea043;
      }

      .btn-danger {
        background: #da3633;
        color: #fff;
        border-color: #f85149;
      }

      .editor-body {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      .CodeMirror {
        height: 100% !important;
        font-size: 14px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      }

      .editor-footer {
        padding: 12px 24px;
        background: #2d2d30;
        border-top: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-info {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: #858585;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-icon {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .status-icon.ready { background: #3fb950; }
      .status-icon.processing { background: #f0b341; }
      .status-icon.blocked { background: #f85149; }

      /* Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      ::-webkit-scrollbar-track {
        background: #1e1e1e;
      }

      ::-webkit-scrollbar-thumb {
        background: #424242;
        border-radius: 6px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #4e4e4e;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .challenge-container {
          flex-direction: column;
        }
        .problem-panel, .editor-panel {
          width: 100%;
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    {% include "components/nav.html"%}

    <div class="challenge-container">
      <!-- Left Panel: Problem Description -->
      <div class="problem-panel">
        <div class="problem-header">
          <h1 class="problem-title">{{task.title}}</h1>
          <div class="problem-meta">
            {% if task.level %}
              <span class="meta-tag level-{{ task.level|lower }}">{{ task.level|capfirst }}</span>
            {% endif %}
            <span class="meta-tag meta-points">{{ task.points }} points</span>
            <span class="meta-tag meta-attempts">{{ current_attempts }}/{{ max_attempts }} attempts</span>
            {% if tasksolution %}
              <span class="meta-tag meta-score">Score: {{ tasksolution.score }}%</span>
            {% endif %}
          </div>
        </div>

        <div class="problem-content">
          <div class="section">
            <h2 class="section-title">Problem Statement</h2>
            <div class="section-text">{{ task.context|linebreaksbr }}</div>
          </div>

          {% if task.task_tests.all %}
          <div class="section">
            <h2 class="section-title">Sample Test Cases</h2>
            {% for test in task.task_tests.all %}
              {% if test.is_sample or test.display %}
              <div class="example-box">
                <div class="example-label">Sample Input {{ forloop.counter }}</div>
                <div class="example-value">{{ test.input|default:"(empty)" }}</div>
              </div>
              <div class="example-box">
                <div class="example-label">Sample Output {{ forloop.counter }}</div>
                <div class="example-value">{{ test.output }}</div>
              </div>
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Right Panel: Code Editor -->
      <div class="editor-panel">
        <div class="editor-header">
          <div class="editor-tabs">
            <div class="editor-tab active">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4 4l3 3-3 3v-2h-4v-2h4v-2zm8 0v2h4v2h-4v2l-3-3 3-3z"/>
              </svg>
              solution.c
            </div>
          </div>
          <div class="editor-actions">
            <button id="resetBtn" class="btn" {% if not can_submit %}disabled{% endif %} title="Reset to initial code">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path d="M3 21v-5h5"/>
              </svg>
              Reset
            </button>
          </div>
        </div>

        <div class="editor-body">
          <textarea id="codeEditor">{% if tasksolution %}{{ tasksolution.code }}{% else %}{{ task.initialCode }}{% endif %}</textarea>
        </div>

        <div class="editor-footer">
          <div class="status-info">
            <div class="status-item">
              <span class="status-icon {% if can_submit %}ready{% elif tasksolution.status == 'processing' %}processing{% else %}blocked{% endif %}"></span>
              <span>
                {% if can_submit %}
                  Ready to submit
                {% elif tasksolution.status == 'processing' %}
                  Processing...
                {% else %}
                  Max attempts reached
                {% endif %}
              </span>
            </div>
            {% if tasksolution %}
            <div class="status-item">
              <span>Status: {{ tasksolution.status|capfirst }}</span>
            </div>
            {% endif %}
          </div>
          <button id="submitBtn" 
                  class="btn {% if can_submit %}btn-success{% else %}btn-danger{% endif %}"
                  {% if not can_submit %}disabled{% endif %}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            {% if can_submit %}
              Submit Code ({{ remaining_attempts }} left)
            {% else %}
              Max Attempts Reached
            {% endif %}
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden Form -->
    <div style="display: none">
      <form action="{{task.id}}" method="POST" id="hiddenForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="uploadedFile" id="uploadedFile" required />
      </form>
    </div>

    <script>
      // Initialize CodeMirror
      let editor;
      const initialCode = `{{task.initialCode|escapejs}}`;
      const canSubmit = {{ can_submit|yesno:"true,false" }};
      
      document.addEventListener("DOMContentLoaded", function () {
        editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
          lineNumbers: true,
          mode: "text/x-csrc",
          theme: "monokai",
          indentUnit: 4,
          tabSize: 4,
          matchBrackets: true,
          autoCloseBrackets: true,
          readOnly: !canSubmit,
          lineWrapping: false,
          extraKeys: {
            "Ctrl-Space": "autocomplete",
            "Tab": function(cm) {
              if (cm.somethingSelected()) {
                cm.indentSelection("add");
              } else {
                cm.replaceSelection("    ", "end");
              }
            }
          }
        });

        // Set editor height
        editor.setSize(null, "100%");
      });

      // Reset button
      document.getElementById("resetBtn")?.addEventListener("click", function () {
        if (!this.disabled && editor) {
          editor.setValue(initialCode);
        }
      });

      // Submit button
      document.getElementById("submitBtn")?.addEventListener("click", function () {
        if (this.disabled) return;
        
        const code = editor ? editor.getValue() : document.getElementById("codeEditor").value;

        if (!code.trim()) {
          alert("Please write some code before submitting!");
          return;
        }

        // Create file and submit
        const file = new Blob([code], { type: "text/plain" });
        const inputElement = document.getElementById("uploadedFile");
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([file], "code.c"));
        inputElement.files = dataTransfer.files;

        // Submit form
        document.getElementById("hiddenForm").submit();
      });

      // Navigation menu functions
      function toggleMenu() {
        const menu = document.getElementById("dropdownMenu");
        if (menu) menu.style.display = menu.style.display === "flex" ? "none" : "flex";
      }

      function closeDropDown() {
        const menu = document.getElementById("dropdownMenu");
        if (menu && menu.style.display === "flex") menu.style.display = "none";
      }
    </script>
  </body>
</html>
   

  </head>
  <body>
    <section class="all-Page" id="all-Page-details">
      
      {% include "components/nav.html"%}

      <main class="container" id="container-details">
        <div class="challenge-header">
          <h1>{{task.title}}</h1>
          <div class="challenge-meta">
            {% if task.level %}
              <span class="level-tag {{ task.level|lower }}">Level: {{task.level|capfirst}}</span>
            {% endif %}
            <span>Score: {{task.points}} points</span>
            <span>Phase: {{task.phase.name}} </span>
          </div>
        </div>
        <div class="challenge-problematic">
          <p>{{ task.context|linebreaksbr }}</p>
        </div>
        <div class="challenge-example">
          
        {% if task.task_tests.all%}  
          <h3>Example:</h3>
          <div>
            {% for test in task.task_tests.all %}
              <span>Input: {{test.input}}</span>
              <span>Output: {{test.output}}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        
       
        <h2>Code:</h2>
        <div class="challenge-code" style="position: relative;">
          <button id="resetBtn" 
                  {% if not can_submit %}disabled{% endif %}
                  style="position: absolute; top: 10px; right: 10px; z-index: 1000; 
                         background: #2d2d2d; border: 1px solid #444; color: #fff; 
                         padding: 8px 12px; border-radius: 4px; cursor: pointer;
                         font-size: 14px; display: flex; align-items: center; gap: 6px;
                         {% if not can_submit %}opacity: 0.5; cursor: not-allowed;{% endif %}"
                  title="Reset to initial code">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 21v-5h5"/>
            </svg>
            Reset
          </button>
          <textarea id="textInput" {% if not can_submit %}disabled{% endif %}>{% if tasksolution %}{{ tasksolution.code }}{% else %}{{ task.initialCode }}{% endif %}</textarea>
        </div>
        <div class="challenge-submit">
          <div class="challenge-meta">
            <span>Attempts: {{ current_attempts }}/{{ max_attempts }}</span>
            {% if tasksolution %}
              <span>Your Score: {{ tasksolution.score }}%</span>
              <span>Status: {{ tasksolution.status|capfirst }}</span>
            {% endif %}
          </div>
          <button id="downloadBtn" 
                  {% if not can_submit %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
            {% if can_submit %}
              Submit ({{ remaining_attempts }} left)
            {% else %}
              Max Attempts Reached
            {% endif %}
          </button>
        </div>
</main>
<div style="display: none">
  <form action="{{task.id}}" method="POST" id="hiddenForm"  enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="uploadedFile" id="uploadedFile" required />
  </form>
</div>
</section>

<script>
  function toggleMenu() {
    const menu = document.getElementById("dropdownMenu");
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  }

  function closeDropDown() {
    const menu = document.getElementById("dropdownMenu");
    if (menu.style.display === "flex") menu.style.display = "none";
  }

  // Initialize CodeMirror
  let editor;
  const initialCode = `{{task.initialCode|escapejs}}`;
  
  document.addEventListener("DOMContentLoaded", function () {
    const canSubmit = {{ can_submit|yesno:"true,false" }};
    
    editor = CodeMirror.fromTextArea(document.getElementById("textInput"), {
      lineNumbers: true,
      mode: "text/x-csrc",
      theme: "monokai",
      indentUnit: 4,
      matchBrackets: true,
      readOnly: !canSubmit
    });
  });

  // Reset button functionality
  document.getElementById("resetBtn").addEventListener("click", function () {
    // Check if button is disabled
    if (this.disabled) {
      return;
    }
    
    // Reset the code to initial value
    if (editor) {
      editor.setValue(initialCode);
    } else {
      document.getElementById("textInput").value = initialCode;
    }
  });

  document.getElementById("downloadBtn").addEventListener("click", function () {
    // Check if button is disabled
    if (this.disabled) {
      return;
    }
    
    const textContent = editor ? editor.getValue() : document.getElementById("textInput").value;

    // Create the file
    const file = new Blob([textContent], { type: "text/plain" });

    // Set the file as value for the hidden input
    const inputElement = document.getElementById("uploadedFile");
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(new File([file], "code.txt"));
    inputElement.files = dataTransfer.files;

    // Submit the form directly without downloading
    document.getElementById("hiddenForm").submit();
  });
</script>

  </body>
</html>
