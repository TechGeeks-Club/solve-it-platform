{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Challenge Details</title>
    <link rel="stylesheet" href="{% static 'css/challenge-page.css' %}" />
    {% include "components/com_header.html"%}

    {% comment %} <link rel="stylesheet" href="{% static 'editor/css/codemirror.min.css' %}" /> {% endcomment %}
    {% comment %} <link rel="stylesheet" href="{% static 'editor/css/monokai.min.css' %}" /> {% endcomment %}
    {% comment %} <script src="{% static 'editor/js/codemirror.min.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'editor/js/clike.min.js' %}"></script> {% endcomment %}
   

  </head>
  <body>
    <section class="all-Page" id="all-Page-details">
      
      {% include "components/nav.html"%}

      <main class="container" id="container-details">
        <div class="challenge-header">
          <h1>{{task.title}}</h1>
          <div class="challenge-meta">
            {% if task.level %}
              <span class="level-tag {{ task.level|lower }}">Level: {{task.level|capfirst}}</span>
            {% endif %}
            <span>Score: {{task.points}} points</span>
            <span>Phase: {{task.phase.name}} </span>
          </div>
        </div>
        <div class="challenge-problematic">
          <p>{{ task.context|linebreaksbr }}</p>
        </div>
        <div class="challenge-example">
          
        {% if task.task_tests.all%}  
          <h3>Example:</h3>
          <div>
            {% for test in task.task_tests.all %}
              <span>Input: {{test.input}}</span>
              <span>Output: {{test.output}}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        
       
        <h2>Code:</h2>
        <div class="challenge-code" style="position: relative;">
          <button id="resetBtn" 
                  {% if not can_submit %}disabled{% endif %}
                  style="position: absolute; top: 10px; right: 10px; z-index: 1000; 
                         background: #2d2d2d; border: 1px solid #444; color: #fff; 
                         padding: 8px 12px; border-radius: 4px; cursor: pointer;
                         font-size: 14px; display: flex; align-items: center; gap: 6px;
                         {% if not can_submit %}opacity: 0.5; cursor: not-allowed;{% endif %}"
                  title="Reset to initial code">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 21v-5h5"/>
            </svg>
            Reset
          </button>
          <textarea id="textInput" {% if not can_submit %}disabled{% endif %}>{% if tasksolution %}{{ tasksolution.code }}{% else %}{{ task.initialCode }}{% endif %}</textarea>
        </div>
        <div class="challenge-submit">
          <div class="challenge-meta">
            <span>Attempts: {{ current_attempts }}/{{ max_attempts }}</span>
            {% if tasksolution %}
              <span>Your Score: {{ tasksolution.score }}%</span>
              <span>Status: {{ tasksolution.status|capfirst }}</span>
            {% endif %}
          </div>
          <button id="downloadBtn" 
                  {% if not can_submit %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
            {% if can_submit %}
              Submit ({{ remaining_attempts }} left)
            {% else %}
              Max Attempts Reached
            {% endif %}
          </button>
        </div>
</main>
<div style="display: none">
  <form action="{{task.id}}" method="POST" id="hiddenForm"  enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="uploadedFile" id="uploadedFile" required />
  </form>
</div>
</section>

<script>
  function toggleMenu() {
    const menu = document.getElementById("dropdownMenu");
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  }

  function closeDropDown() {
    const menu = document.getElementById("dropdownMenu");
    if (menu.style.display === "flex") menu.style.display = "none";
  }

  // Initialize CodeMirror
  let editor;
  const initialCode = `{{task.initialCode|escapejs}}`;
  
  document.addEventListener("DOMContentLoaded", function () {
    const canSubmit = {{ can_submit|yesno:"true,false" }};
    
    editor = CodeMirror.fromTextArea(document.getElementById("textInput"), {
      lineNumbers: true,
      mode: "text/x-csrc",
      theme: "monokai",
      indentUnit: 4,
      matchBrackets: true,
      readOnly: !canSubmit
    });
  });

  // Reset button functionality
  document.getElementById("resetBtn").addEventListener("click", function () {
    // Check if button is disabled
    if (this.disabled) {
      return;
    }
    
    // Reset the code to initial value
    if (editor) {
      editor.setValue(initialCode);
    } else {
      document.getElementById("textInput").value = initialCode;
    }
  });

  document.getElementById("downloadBtn").addEventListener("click", function () {
    // Check if button is disabled
    if (this.disabled) {
      return;
    }
    
    const textContent = editor ? editor.getValue() : document.getElementById("textInput").value;

    // Create the file
    const file = new Blob([textContent], { type: "text/plain" });

    // Set the file as value for the hidden input
    const inputElement = document.getElementById("uploadedFile");
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(new File([file], "code.txt"));
    inputElement.files = dataTransfer.files;

    // Submit the form directly without downloading
    document.getElementById("hiddenForm").submit();
  });
</script>

  </body>
</html>
