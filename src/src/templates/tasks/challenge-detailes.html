{% extends "components/base.html" %}
{% load static %}

{% block title %}{{task.title}} - Challenge{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

{% include "components/common-styles.html" %}
<link rel="stylesheet" href="{% static 'css/challenge-details.css' %}">
{% endblock %}

{% block content %}
{% include "components/navbar.html" %}

<div class="challenge-container">
  <!-- Left Panel: Problem Description -->
  <div class="problem-panel" id="problemPanel">
    <div class="problem-header">
      <h1 class="problem-title">{{task.title}}</h1>
      <div class="problem-meta">
        {% if task.level %}
          <span class="meta-tag level-{{ task.level|lower }}">{{ task.level|capfirst }}</span>
        {% endif %}
        <span class="meta-tag meta-points">{{ task.points }} points</span>
        <span class="meta-tag meta-attempts">{{ current_attempts }}/{{ max_attempts }} attempts</span>
        {% if tasksolution %}
          <span class="meta-tag meta-score">Score: {{ tasksolution.score }}%</span>
        {% endif %}
      </div>
    </div>

    <div class="problem-content">
      <div class="section">
        <h2 class="section-title">Problem Statement</h2>
        <div class="section-text">{{ task.context|linebreaksbr }}</div>
      </div>

      {% if task.task_tests.all %}
      <div class="section">
        <h2 class="section-title">Sample Test Cases</h2>
        {% for test in task.task_tests.all %}
          {% if test.is_sample or test.display %}
          <div class="example-box">
            <div class="example-label">Sample Input {{ forloop.counter }}</div>
            <div class="example-value">{{ test.input|default:"(empty)" }}</div>
          </div>
          <div class="example-box">
            <div class="example-label">Sample Output {{ forloop.counter }}</div>
            <div class="example-value">{{ test.output }}</div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Resize Handle -->
  <div class="resize-handle" id="resizeHandle1"></div>

  <!-- Right Panel: Code Editor -->
  <div class="editor-panel" id="editorPanel">
    <div class="editor-header">
      <div class="editor-tabs">
        <div class="editor-tab active">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4.708 5.578L2.061 8.224l2.647 2.646-.708.708-3-3V7.87l3-3 .708.708zm7-.708L11 5.578l2.647 2.646L11 10.87l.708.708 3-3V7.87l-3-3zM4.908 13l.894.448 5-10L9.908 3l-5 10z"/>
          </svg>
          solution.c
        </div>
      </div>
      <div class="editor-actions">
        <button id="resetBtn" class="btn" {% if not can_submit %}disabled{% endif %} title="Reset to initial code">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
            <path d="M21 3v5h-5"/>
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
            <path d="M3 21v-5h5"/>
          </svg>
          Reset
        </button>
      </div>
    </div>

    <div class="editor-body" id="editorBody">
      <textarea id="codeEditor">{% if tasksolution %}{{ tasksolution.code }}{% else %}{{ task.initialCode }}{% endif %}</textarea>
    </div>

    <!-- Resize Handle between editor and test results -->
    <div class="resize-handle-horizontal" id="resizeHandle2"></div>

    <div class="editor-footer">
      <div class="status-info">
        <div class="status-item">
          <span class="status-icon {% if can_submit %}ready{% elif tasksolution.status == 'processing' %}processing{% elif tasksolution.status == 'completed' %}ready{% else %}blocked{% endif %}"></span>
          <span>
            {% if can_submit and not tasksolution %}
              Ready to submit
            {% elif tasksolution.status == 'processing' %}
              Processing...
            {% elif tasksolution.status == 'completed' %}
              Passed ({{ tasksolution.score }}%)
            {% elif tasksolution.status == 'failed' %}
              Failed ({{ tasksolution.score }}%)
            {% elif not can_submit %}
              Max attempts reached
            {% else %}
              Ready to submit
            {% endif %}
          </span>
        </div>
        {% if tasksolution and tasksolution.is_corrected %}
        <div class="status-item">
          <span>Result: 
            <span style="color: {% if tasksolution.status == 'completed' %}#3fb950{% elif tasksolution.status == 'failed' %}#f85149{% else %}#f0b341{% endif %}; font-weight: 600;">
              {{ tasksolution.status|capfirst }}
            </span>
          </span>
        </div>
        {% endif %}
      </div>
      <button id="submitBtn" 
              class="btn {% if tasksolution.status == 'processing' %}btn-warning{% elif can_submit %}btn-success{% else %}btn-danger{% endif %}"
              {% if not can_submit or tasksolution.status == 'processing' %}disabled{% endif %}
              data-has-previous="{{ tasksolution|yesno:'true,false' }}"
              data-current-attempts="{{ current_attempts|default:0 }}"
              data-current-score="{{ tasksolution.score|default:0 }}"
              data-max-attempts="{{ max_attempts }}">
        {% if tasksolution.status == 'processing' %}
          <div class="spinner"></div>
          Processing...
        {% else %}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          {% if can_submit %}
            Submit Code ({{ remaining_attempts }} left)
          {% else %}
            Max Attempts Reached
          {% endif %}
        {% endif %}
      </button>
      
      <!-- Time Machine Button -->
      {% if has_time_machine and not can_submit %}
      <form method="POST" action="{% url 'use_time_machine' task.id %}" style="display: inline-block; margin-left: 12px;">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; display: flex; align-items: center; gap: 8px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Use Time Machine
        </button>
      </form>
      {% elif time_machine_used %}
      <button class="btn btn-secondary" disabled style="margin-left: 12px; opacity: 0.5; display: flex; align-items: center; gap: 8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Time Machine Used
      </button>
      {% endif %}
    </div>

    <!-- Test Results Section -->
    {% if tasksolution and tasksolution.test_results %}
    <div class="test-results-section" id="testResultsSection">
      <div class="test-results-header">
        <div class="test-results-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          Test Cases
        </div>
        <div class="test-results-summary">
          {{ tasksolution.passed_tests }}/{{ tasksolution.total_tests }} passed
        </div>
      </div>
      <div class="test-results-list">
        {% for test in tasksolution.test_results %}
        <div class="test-case-item {% if test.passed %}passed{% else %}failed{% endif %}">
          <div class="test-case-header {% if not test.display %}locked{% endif %}" onclick="{% if test.display %}toggleTestCase({{ forloop.counter0 }}){% endif %}">
            <div class="test-case-name">
              <span class="test-status-icon">
                {% if test.passed %}✓{% else %}✗{% endif %}
              </span>
              Test Case {{ forloop.counter }}
            </div>
            <div class="test-case-right">
              <div class="test-case-status {% if test.passed %}passed{% else %}failed{% endif %}">
                {% if test.passed %}
                  Passed
                {% else %}
                  Failed
                {% endif %}
              </div>
              {% if test.display %}
                <span class="accordion-icon" id="accordion-icon-{{ forloop.counter0 }}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </span>
              {% else %}
                <span class="lock-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                </span>
              {% endif %}
            </div>
          </div>
          {% if test.display %}
          <div class="test-case-details" id="test-details-{{ forloop.counter0 }}">
            <div class="test-case-content">
              <div class="test-io-section">
                <div class="test-io-label">Input</div>
                <div class="test-io-value">{{ test.input|default:"(empty)" }}</div>
              </div>
              <div class="test-io-section">
                <div class="test-io-label">Expected Output</div>
                <div class="test-io-value">{{ test.expected_output|default:"N/A" }}</div>
              </div>
              {% if not test.passed and test.actual_output %}
              <div class="test-io-section">
                <div class="test-io-label">Your Output</div>
                <div class="test-io-value">{{ test.actual_output }}</div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Hidden Form -->
<div style="display: none">
  <form action="{{task.id}}" method="POST" id="hiddenForm" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="uploadedFile" id="uploadedFile" required />
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>

<script>
  // Pass Django template variables to JavaScript
  window.initialCode = `{{task.initialCode|escapejs}}`;
  window.canSubmit = {{ can_submit|yesno:"true,false" }};
  
  // Set global variables for the external script
  initialCode = window.initialCode;
  canSubmit = window.canSubmit;
</script>

<script src="{% static 'js/challenge-details.js' %}"></script>
{% endblock %}
